var a;function get_incidents(){jQuery.getJSON("/json/STCC-STCC.json",function(b){build_incident_list(b);typeof trafficmap!="undefined"&&trafficmap.update(b)})}function tbxy2latlng(b){b=b.split(/:/);return{lat:b[1]*2.74E-6+33.172,lng:b[0]*3.5E-6-144.966}}
Date.prototype.getISO8601=function(){var b=this.getMonth()+1<10?"0"+this.getMonth()+1:this.getMonth()+1,c=this.getDate()<10?"0"+this.getDate():this.getDate(),d=this.getHours()<10?"0"+this.getHours():this.getHours(),f=this.getMinutes()<10?"0"+this.getMinutes():this.getMinutes(),e=this.getSeconds()<10?"0"+this.getSeconds():this.getSeconds(),g=this.getTimezoneOffset()/60;return this.getFullYear()+"-"+b+"-"+c+"T"+d+":"+f+":"+e+"-0"+g+"00"};var showing_details={};function show_incident(b,c){var d=false;jQuery("#incidents_above").empty();jQuery("#incidents_below").hide();jQuery.each(b,function(f,e){if(e.ID==c){document.title+=": "+e.LogType;jQuery("#header h1").html(e.LogType);display_incident(e).appendTo("#incidents_above");jQuery("#incidents_above .details").show();d=true}});d||jQuery("#incidents_above").append(jQuery("<b/>").html("The incident you requested does not exist or is no longer active."))}
function build_incident_list(b){jQuery(".incidents").empty();jQuery("#mediainfo").empty();jQuery.each(b,function(c,d){if(d.LogType=="Media Information"){if(d.LogDetails.details.length>0){display_details(d.LogDetails.details).appendTo("#mediainfo");jQuery("#mediainfo").show()}}else{c=c<4?"#incidents_above":"#incidents_below";display_incident(d).appendTo(c)}});jQuery(".incidents li:last-child").addClass("last")}
function display_incident(b){var c=new Date(b.LogTimeEpoch*1E3),d=b.TBXY&&b.TBXY!=""?tbxy2latlng(b.TBXY):null,f=b.LogDetails.details.length>1?"slow":"fast",e=b.LogDetails.details.length>0?"Click for incident details ("+b.LogDetails.details.length+")":"",g=display_details(b.LogDetails.details);c=jQuery("<li/>").attr("id",b.ID).attr("title",e).addClass("vevent").append(jQuery("<div/>").addClass("logtype summary").html(b.LogType)).append(jQuery("<div/>").addClass("location").html(b.Location+"<br/>"+
b.Area).append(jQuery("<button/>").html("Show on map").click(function(){if(d){jQuery(this).parent().click();location="http://maps.google.com/maps?q="+d.lat+","+d.lng}}))).append(jQuery("<div/>").addClass("logtime").html(b.LogTime).append(jQuery("<span/>").addClass("dtstart").html(c.getISO8601()))).append(g).hover(function(){typeof trafficmap!="undefined"&&trafficmap.center_on_id(b.ID)},function(){typeof trafficmap!="undefined"&&trafficmap.recenter()}).click(function(){if(b.LogDetails.details.length>
0){g.toggle(f);showing_details[b.ID]=showing_details[b.ID]?false:true}});showing_details[b.ID]&&g.css("display","block");if(d){e="/images/incident.png";if(!/Traffic Hazard|Disabled Vehicle/.test(b.LogType))if(/Collision|Fatality|Hit \& Run/.test(b.LogType))e="/images/accident.png";jQuery("<img/>").attr("src",e).attr("height","18").attr("width","18").prependTo(c);jQuery("<div/>").addClass("geo").append(jQuery("<span/>").addClass("latitude").html(d.lat)).append(jQuery("<span/>").addClass("longitude").html(d.lng)).appendTo(c)}return c}
function display_details(b){var c=jQuery("<ul/>").addClass("details");jQuery.each(b,function(d,f){jQuery("<li/>").append(jQuery("<span/>").addClass("detailtime").html(f.DetailTime)).append(jQuery("<span/>").addClass("incidentdetail").html(f.IncidentDetail.replace(/(\*.+?\*)/,'<span class="alert">$1</span>'))).appendTo(c)});return c};function TrafficMap(b){var c=this;this.center=new GLatLng(38.56,-121.4);this.live_cams=[];this.traffic_overlay=null;this.marker_list={};this.gmap=new GMap2(document.getElementById(b));this.gmap.setCenter(this.center,10);this.gmap.addControl(new GSmallMapControl);GEvent.addListener(this.gmap,"dragend",function(){c.center=c.gmap.getCenter()});jQuery(window).unload(function(){GUnload()})}a=TrafficMap.prototype;
a.load_live_cams=function(b){var c=this;jQuery.ajax({url:b,dataType:"xml",success:function(d){function f(h){var k=h.getAttribute("id"),j=h.getAttribute("name"),l=h.getElementsByTagName("location")[0].getAttribute("lon"),m=h.getElementsByTagName("location")[0].getAttribute("lat"),n=h.getElementsByTagName("size")[0].getAttribute("height"),o=h.getElementsByTagName("size")[0].getAttribute("width");h=new GMarker(new GPoint(l,m),{title:j,icon:e});GEvent.addListener(h,"click",function(){var p=j.replace(/ /g,
"_").replace(/-/g,"_"),q=parseInt(o)+60,r=parseInt(n)+170;window.open("../showcamera.php?id="+k,p,"width="+q+",height="+r)});return h}var e=new GIcon;e.image="/images/camera_icon.gif";e.iconSize=new GSize(24,24);e.iconAnchor=new GPoint(12,12);e.infoWindowAnchor=new GPoint(12,1);for(var g=0;g<d.getElementsByTagName("camera").length;g++){var i=d.getElementsByTagName("camera")[g];i=f(i);c.live_cams.push(i)}c.show_live_cams()}})};
a.update=function(b){this.hide_incidents();this.marker_list={};for(var c=0;c<b.length;c++){var d=b[c],f=this.make_marker(d);if(f){this.marker_list[d.ID]=f;this.gmap.addOverlay(f)}}};a.show_incident=function(b,c){for(var d=0;d<b.length;d++){var f=b[d];if(f.ID==c){if(b=this.make_marker(f)){this.gmap.addOverlay(b);this.gmap.setCenter(b.getLatLng(),13)}break}}};a.show_live_cams=function(){for(var b=0;b<this.live_cams.length;b++)this.gmap.addOverlay(this.live_cams[b])};
a.hide_live_cams=function(){for(var b=0;b<this.live_cams.length;b++)this.gmap.removeOverlay(this.live_cams[b])};a.show_gtraffic=function(){this.traffic_overlay=new GTrafficOverlay({incidents:true});this.gmap.addOverlay(this.traffic_overlay)};a.hide_gtraffic=function(){this.traffic_overlay&&this.gmap.removeOverlay(this.traffic_overlay)};a.center_on_id=function(b){this.marker_list[b]&&this.gmap.panTo(this.marker_list[b].getLatLng())};a.recenter=function(){this.gmap.panTo(this.center)};
a.hide_incidents=function(){for(var b in this.marker_list)this.gmap.removeOverlay(this.marker_list[b])};
a.make_marker=function(b){if(b.TBXY&&b.TBXY!=""&&b.LogType!="Media Information"){var c=new GIcon(G_DEFAULT_ICON);c.image="/images/incident.png";c.shadow="/images/traffic_incident_shadow.png";c.iconSize=new GSize(18,18);c.shadowSize=new GSize(23,23);c.iconAnchor=new GPoint(9,9);c.infoWindowAnchor=new GPoint(8,3);var d=tbxy2latlng(b.TBXY),f=new GLatLng(d.lat,d.lng);if(!/Traffic Hazard|Disabled Vehicle/.test(b.LogType))if(/Collision|Fatality|Hit \& Run/.test(b.LogType))c.image="/images/accident.png";
var e=new GMarker(f,{icon:c,zIndexProcess:function(){return GOverlay.getZIndex(f.lat())*2}});GEvent.addListener(e,"click",function(){e.openInfoWindowHtml('<div class="marker"><div class="logtype">'+b.LogType+'</div><div class="location">'+b.Location+'</div><div class="logtime">'+b.LogTime+"</div></div>")});return e}};var TrafficNews={};TrafficNews.show=function(b,c,d){(new google.feeds.Feed(c)).load(function(f){if(!f.error){var e=false;jQuery(b).empty();jQuery.each(f.feed.entries,function(g,i){if(d){g=new Date((new Date).getTime()-86400*d*1E3);if(new Date(i.publishedDate)<g)return false}e=true;jQuery(b).append(jQuery("<li/>").append(jQuery("<a/>").attr("href",i.link).html(i.title)).append("<br/>").append(jQuery("<span/>").html(i.contentSnippet)))});e&&jQuery("#sitenews").show("slow")}})};